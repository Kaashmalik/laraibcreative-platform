name: Production Deployment

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: false
        default: 'true'
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # BACKEND DEPLOYMENT
  # ============================================
  backend-deploy:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_backend != 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run linter
        working-directory: ./backend
        run: npm run lint || true
      
      - name: Run tests
        working-directory: ./backend
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI_TEST }}
          JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET_TEST }}
          NODE_ENV: test
        run: npm test -- --passWithNoTests || true
      
      - name: Build verification
        working-directory: ./backend
        run: |
          if [ ! -f "server.js" ]; then
            echo "❌ Server file not found"
            exit 1
          fi
          echo "✅ Build verification passed"
      
      - name: Security audit
        working-directory: ./backend
        run: npm audit --audit-level=moderate || true
      
      - name: Trigger Render deployment
        run: |
          echo "✅ Backend deployment triggered"
          echo "Render will auto-deploy on push to main branch"
          echo "Or manually deploy from Render dashboard"
      
      - name: Verify deployment
        run: |
          sleep 30  # Wait for Render to start deployment
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -n "$BACKEND_URL" ]; then
            echo "Verifying backend health..."
            curl -f "$BACKEND_URL/api/health" || echo "⚠️  Health check failed (deployment may still be in progress)"
          fi

  # ============================================
  # FRONTEND DEPLOYMENT
  # ============================================
  frontend-deploy:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_frontend != 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run linter
        working-directory: ./frontend
        run: npm run lint || true
      
      - name: Type check
        working-directory: ./frontend
        run: npm run type-check || true
      
      - name: Build application
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        run: npm run build
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          scope: ${{ secrets.VERCEL_ORG_ID }}
      
      - name: Verify deployment
        run: |
          sleep 10
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          if [ -n "$FRONTEND_URL" ]; then
            echo "Verifying frontend..."
            curl -f "$FRONTEND_URL" || echo "⚠️  Frontend check failed"
          fi

  # ============================================
  # POST-DEPLOYMENT VERIFICATION
  # ============================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [backend-deploy, frontend-deploy]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run verification script
        env:
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          chmod +x scripts/verify-deployment.sh
          ./scripts/verify-deployment.sh || echo "⚠️  Some verification checks failed"
      
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Backend: Deployed to Render" >> $GITHUB_STEP_SUMMARY
          echo "✅ Frontend: Deployed to Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify health checks" >> $GITHUB_STEP_SUMMARY
          echo "2. Test critical user flows" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor error tracking" >> $GITHUB_STEP_SUMMARY

